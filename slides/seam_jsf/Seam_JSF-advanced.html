<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js ie6" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

<title>Nuxeo training - Seam & JSF</title>

<meta name="description" content="Nuxeo - Configuration and Integration">
<meta name="author" content="Nuxeo">
<meta name="viewport" content="width=1024, user-scalable=no">

<!-- Core and extension CSS files -->
<link rel="stylesheet" href="../deck.js/core/deck.core.css">
<link rel="stylesheet" href="../deck.js/extensions/goto/deck.goto.css">
<link rel="stylesheet" href="../deck.js/extensions/menu/deck.menu.css">
<link rel="stylesheet"
  href="../deck.js/extensions/navigation/deck.navigation.css">
<link rel="stylesheet" href="../deck.js/extensions/status/deck.status.css">
<link rel="stylesheet" href="../deck.js/extensions/hash/deck.hash.css">
<link rel="stylesheet" href="../deck.js/extensions/scale/deck.scale.css">

<!-- Nuxeo Slide Default theme -->
<link rel="stylesheet"
  href="../nuxeo-slide-template/themes/style/nuxeo-theme.css">

<!-- Nuxeo Slide with comments theme -->
<link rel="stylesheet alternate" title="with comments"
  href="../nuxeo-slide-template/themes/style/nuxeo-theme-with-comments.css">

<!-- Transition theme. More available in /themes/transition/ or create your own. -->
<link rel="stylesheet"
  href="../nuxeo-slide-template/themes/transition/nuxeo-transition.css">

<script src="../deck.js/modernizr.custom.js"></script>
</head>

<body class="deck-container">

<section class="slide" id="title">
# Nuxeo training - Advanced Seam & JSF
</section>

<section class="slide" id="jsf">
##JSF main concepts - Advanced information
</section>

<section class="slide" id="jsf-lifecycle-tree">
###Life Cycle & Component Tree

  <img src="./img/jsf_lifecycle_tree.png" />

</section>

<section class="slide" id="jsf-postback">
###JSF Post Back & Context

  <img src="./img/jsf_postback.png" />

  State is restored when posting a form, and when a validation error occurs

</section>

<section class="slide" id="jsf-facelets-schema">
### JSF & Facelets
  <img src="./img/jsf-lc-facelets.JPG" />
</section>

<section class="slide" id="jsf-special-cases">
###JSF Special Cases

- Cross validation
    - problem: need validate before the update model phase
    - solution: add a hidden component that retrieves values on other components and validate them

- Ajax interactions
    - fine control over behaviour (posting, rerendering,... )
    - fine control over validation and update
</section>

<section class="slide" id="jsf-lifecycle-schema-immediate">
###JSF Life Cycle - immediate use case

  <img src="./img/jsf_immediate.png" />
</section>

<section class="slide" id="seam">
##Seam Main Concepts
</section>

<section class="slide" id="seam-jsf-role">
###Seam & JSF Life Cycle

<img src="./img/jsf-seam-lifecycle.JPG" />

</section>

<section class="slide" id="nuxeo-webapp">
##Nuxeo JSF WebApp
</section>

<section class="slide" id="global-picture">
###Global picture

  <img src="./img/global_picture.png" />
</section>

<section class="slide" id="nuxeo-webapp-event-invalidations">
###Event based invalidation

- Conversation beans hold some cache
    - data computed about the currentDocument (relations, history ....)
- Cache invalidation is needed
- Seam Events are used for that: components are notified via <code>@Observers</code>
- Can also use <code>DocumentContextBoundActionBean</code> for optimization
</section>

<section class="slide" id="nuxeo-seam-delegates">
###Seam Delegates in Nuxeo

- Use <code>@Unwrap</code> annotation to access Nuxeo Service as native Seam components
- can access Nuxeo services via injection
    - <code>@In</code> CoreSession documentManager
    - <code>@In</code> RelationManager relationManager

- Framework.getLocalService can be an alternative for service lookup
</section>

<section class="slide" id="nuxeo-seam-factories">
###Seam Factories in Nuxeo

Seam factories are used to fill the context

- avoids multiple calls
- avoids managing state in the components
</section>

<section class="slide" id="nuxeo-jsf-integration">
##Nuxeo JSF integration</h3>
</section>

<section class="slide" id="nuxeo-jsf-tag-libraries">
###Nuxeo JSF Tag libraries

Nuxeo provides several tag libraries

- nxu: utility functions (nxu:inputList, nxu:set, nxu:valueHolder)
- nxd: document related functions (nxd:titleOrId(document), etc...)
- nxl: layout/widgets support
- nxdir: directorybound components
</section>

<section class="slide" id="layouts">
##Layouts &amp; Widgets</h3>
</section>

<section class="slide" id="actions">
  <h2>Actions</h2>
</section>

<section class="slide" id="actions-xhtml">
###Actions Usage in xhtml Pages

Most of the time, actions rendering depends on their category, although
some improvements have been made in more recent Nuxeo versions.

<pre>
<code>
  &lt;nxu:set var="actions" cache="true"
    value="#{webActions.getActionsList('DOCUMENT_UPPER_ACTION')}"&gt;
    &lt;nxu:dataList layout="simple" var="action" value="#{actions}"&gt;
      &lt;nxh:commandLink action="#{action.getLink()}"
        immediate="#{action.immediate}"
        onclick="#{action.confirm}"&gt;
        &lt;h:graphicImage value="#{action.icon}"
          rendered="#{not empty action.icon}"
          title="#{messages[action.label]}"
          alt="#{messages[action.label]}"
          styleClass="smallIcon" /&gt;
      &lt;/nxh:commandLink&gt;
    &lt;/nxu:dataList&gt;
  &lt;/nxu:set&gt;
</code>
</pre>

</section>

<section class="slide" id="actions-xhtml2">
###Actions Usage in xhtml Pages

New way (from 5.7.1), allows to mix up different renderings depending on
the action, in the same category:
<pre>
<code>
  &lt;nxl:widgetType name="currentDocumentActionsWithForms"
    widgetName="documentActionsUpperButtons"
    mode="view"
    label=""
    styleClass="globalActionBar"
    subStyleClass="contextActions"
    actionStyleClass="button"
    actionsDisplay="icons"
    overallDisplay="horizontal_block"
    category="DOCUMENT_UPPER_ACTION"
    maxActionsNumber="5"
    value="#{currentDocument}" /&gt;
</code>
</pre>

</section>


<section class="slide" id="url-service">
###URL Service

- JSF uses POSTs everywhere
    - urls are not bookmarkable
- Nuxeo adds an URL service
    - let define URL codecs
        - define what must be encoded in urls
            - Document Uid based urls
            - Document Path based urls
            - File download urls
            - ...
    - provides RESTful (GET) navigation in JSF
        - simple navigation in Nuxeo is done via simple GET
</section>

<section class="slide" id="url-codecs">
###URL Codecs

- URL Codecs
  - Transform an url into a  « document view »
  - Restore context from this « document view » and map additional parameters
  - Examples:
      - http://localhost:8080/nuxeo/<code>nxdoc</code>/default/fa431bc8-014d-4d19-9338-216d732ae5b2/view_documents
      - http://localhost:8080/nuxeo/<code>nxpath</code>/default/default-domain/workspaces@view_documents
      - http://localhost:8080/nuxeo/<code>nxfile</code>/default/5003772a-27c8-4231-a5d5-7d19608fbfb7/blobholder:0/Screenshot%20at%202013-06-25%2000%3A11%3A35.png 
- As a service because it has to be accessible by:
  - core services (example: notifications)
  - other frameworks (example: opensocial gadgets)
</section>

<section class="slide" id="url-patterns">
###URL Patterns

URL patterns make the link between the navigation and the URL codec

<pre>
<code>
  &lt;extension target="org.nuxeo.ecm.platform.ui.web.rest.URLService"
    point="urlpatterns"&gt;
    &lt;urlPattern name="default" enabled="true"&gt;
      &lt;defaultURLPolicy&gt;true&lt;/defaultURLPolicy&gt;
      &lt;needBaseURL&gt;true&lt;/needBaseURL&gt;
      [...]
      &lt;codecName&gt;docpath&lt;/codecName&gt;
      &lt;actionBinding&gt;
        #{restHelper.initContextFromRestRequest}
      &lt;/actionBinding&gt;
      [...]
      &lt;bindings&gt;
        &lt;binding name="tabId" callGetter="false"&gt;
          #{webActions.currentTabId}
        &lt;/binding&gt;
      &lt;/bindings&gt;
    &lt;/urlPattern&gt;
  &lt;/extension&gt;
</code>
</pre>

</section>


<section class="slide" id="themes">
##Themes
</section>

<section class="slide" id="nuxeo-themes-overview">
  <h3>Themes</h3>
  <div>
    <img src="./img/themes.png" />
  </div>
</section>

<section class="slide" id="nuxeo-themes-role">
  <h3>Themes Role</h3>
  <div class="split-box split-37">
    <ul>
      <li>Define the branding of an application</li>
      <li>Define global page layouts with reusable components</li>
      <li>Handle CSS/Javascript resources</li>
    </ul>
  </div>
  <div class="split-box split-63">
    <img src="./img/flavors.png" />
  </div>
</section>

<section class="slide" id="theme-features">
  <h3>Themes Features</h3>
  <div class="split-box split-37">
    <ul>
      <li>Use JSF and Freemarker features</li>
      <li>Define sets of reusable CSS files to handle addons and applications</li>
      <li>Provide flavors for easier customization</li>
    </ul>
  </div>
  <div class="split-box split-63">
    <img src="./img/nuxeo_theme_includes.jpg" />
  </div>
</section>

<section class="slide" id="theme-studio">
  <h3>Branding in Nuxeo Studio</h3>
  <div class="split-box split-37">
    <ul>
      <li>Customize login page</li>
      <li>Define flavors</li>
    </ul>
  </div>
  <div class="split-box split-63">
    <img src="./img/studio_new_branding.png" />
  </div>
</section>

<section class="slide" id="theme-xml">
###Theme XML Extensions

- declare the theme
- reference the page layout, referencing view fragments
- link CSS/JS resources
- apply flavours
</section>

<section class="slide" id="nuxeo-theme-more">
###More About Themes

- Themes reference documentation
  <br />
  <a href="http://doc.nuxeo.com/x/N4AO" target="_blank">http://doc.nuxeo.com/x/N4AO</a>
- Showcase for CSS syling of a Nuxeo application
  <br />
  <a href="http://showcase.nuxeo.com/nuxeo/styleGuide/" target="_blank">http://showcase.nuxeo.com/nuxeo/styleGuide/</a>
</section>


<section class="slide" id="content-views">
  <h2>Content Views</h2>
</section>

<section class="slide" id="content-views-overview">
  <h3>Content Views</h3>
  <div>
    <img src="./img/content_view.png" />
  </div>
</section>

<section class="slide" id="content-views-role">
  <h3>Content Views</h3>
  <div class="split-box split-37">
    <ul>
      <li>Define the query to retrieve documents (or other resources)</li>
      <li>Pass on contextual parameters to the query</li>
      <li>Define a filtering form</li>
      <li>Define rendering of items in a table</li>
      <li>Handle selection and actions on items</li>
      <li>Handle sorting and pagination</li>
      <li>Handle cache</li>
    </ul>
  </div>
  <div class="split-box split-63">
    <img src="./img/contentview.png" />
  </div>
</section>

<section class="slide" id="content-views-features">
  <h3>Content Views Features</h3>
  <div class="split-box split-37">
    <ul>
      <li>Reuse underlying layouts and actions features</li>
      <li>Accept pluggable page providers to query custom databases</li>
      <li>Benefit from loose binding of listing layouts</li>
      <li>Pass contextual properties to the page provider (core session for instance)</li>
    </ul>
  </div>
  <div class="split-box split-63">
    <img src="./img/contentview_history.png" />
  </div>
</section>

<section class="slide" id="content-views-xml">
###Content Views Definitions
<pre>
<code>
  &lt;extension target="org.nuxeo.ecm.platform.ui.web.ContentViewService"
    point="contentViews"&gt;
    &lt;contentView name="document_content"&gt;
      &lt;coreQueryPageProvider&gt;
        [...]
      &lt;/coreQueryPageProvider&gt;
      &lt;searchLayout name="document_content_filter"
        filterDisplayType="quick" /&gt;
      &lt;refresh&gt;
        &lt;event&gt;documentChanged&lt;/event&gt;
        &lt;event&gt;documentChildrenChanged&lt;/event&gt;
      &lt;/refresh&gt;
      &lt;cacheKey&gt;#{currentDocument.id}&lt;/cacheKey&gt;
      &lt;cacheSize&gt;10&lt;/cacheSize&gt;
      &lt;resultLayouts&gt;
        &lt;layout
          name="document_listing_ajax"
          title="document_listing"
          translateTitle="true"
          iconPath="/icons/document_listing_icon.png"
          showCSVExport="true"
          showPDFExport="false"
          showSyndicationLinks="true" /&gt;
      &lt;/resultLayouts&gt;
      &lt;selectionList&gt;CURRENT_SELECTION&lt;/selectionList&gt;
      &lt;actions category="CURRENT_SELECTION_LIST" /&gt;
    &lt;/contentView&gt;
  &lt;/extension&gt;
</code>
</pre>
</section>


<section class="slide" id="page-providers-xml">
###Page Providers Definitions
<pre>
<code>
  &lt;coreQueryPageProvider&gt;
    &lt;property name="coreSession"&gt;#{documentManager}&lt;/property&gt;
    &lt;property name="maxResults"&gt;DEFAULT_NAVIGATION_RESULTS&lt;/property&gt;
    &lt;whereClause docType="AdvancedSearch"&gt;
      &lt;predicate parameter="ecm:fulltext" operator="FULLTEXT"&gt;
        &lt;field schema="advanced_search" name="fulltext_all" /&gt;
      &lt;/predicate&gt;
      &lt;predicate parameter="dc:title" operator="FULLTEXT"&gt;
        &lt;field schema="advanced_search" name="title" /&gt;
      &lt;/predicate&gt;
      &lt;predicate parameter="dc:modified" operator="BETWEEN"&gt;
        &lt;field schema="advanced_search" name="modified_min" /&gt;
        &lt;field schema="advanced_search" name="modified_max" /&gt;
      &lt;/predicate&gt;
      &lt;fixedPart&gt;
        ecm:parentId = ? AND ecm:isCheckedInVersion = 0
        AND ecm:mixinType != 'HiddenInNavigation'
        AND ecm:currentLifeCycleState != 'deleted'
      &lt;/fixedPart&gt;
    &lt;/whereClause&gt;
    &lt;parameter&gt;#{currentDocument.id}&lt;/parameter&gt;
    &lt;sort column="dc:title" ascending="true" /&gt;
    &lt;pageSize&gt;20&lt;/pageSize&gt;
  &lt;/coreQueryPageProvider&gt;
</code>
</pre>
</section>

<section class="slide" id="custom-page-providers">
###Custom page providers

Benefit from:

- default page providers API (next, prev, etc...)
- default content views rendering
    - use layouts loose binding for results rendering

<pre>
<code>
  &lt;extension
    target="org.nuxeo.ecm.platform.query.api.PageProviderService"
    point="providers"&gt;
    &lt;genericPageProvider
      class="org.nuxeo.ecm.platform.audit.api.document.DocumentHistoryPageProvider"
      name="DOCUMENT_HISTORY_PROVIDER"&gt;
      &lt;whereClause docType="BasicAuditSearch"&gt;
        &lt;predicate parameter="log.eventDate" operator="BETWEEN"&gt;
          &lt;field schema="basicauditsearch" name="startDate" /&gt;
          &lt;field schema="basicauditsearch" name="endDate" /&gt;
        &lt;/predicate&gt;
      &lt;/whereClause&gt;
      &lt;sort column="log.eventDate" ascending="true" /&gt;
      &lt;sort column="log.id" ascending="true" /&gt;
      &lt;pageSize&gt;10&lt;/pageSize&gt;
    &lt;/genericPageProvider&gt;
  &lt;/extension&gt;
</code>
</pre>
</section>

<section class="slide" id="content-views-xhtml">
###Content Views usage in xhtml pages

<pre>
<code>
  &lt;nxu:set var="contentViewId" value="unique_cv_id"&gt;
  &lt;nxu:set var="contentViewName" value="document_content"&gt;

    &lt;ui:decorate template="/incl/content_view.xhtml" /&gt;

  &lt;/nxu:set&gt;
  &lt;/nxu:set&gt;
</code>
</pre>
</section>

<section class="slide" id="agenda-nuxeo-design-advice">
###Agenda
- <a href="#technologies-overview">Technologies overview</b>
- <a href="#jsf">JSF main concepts</a>
- <a href="#seam">Seam main concepts</a>
- <a href="#nuxeo-webapp">Nuxeo JSF Webapp</a>
- <a href="#nuxeo-jsf">Nuxeo JSF Integration</a>
- <a href="#design-advice"><span class="bold">Design notes & standard pitfalls</span></a>
- <a href="#training-exercise">Training Exercise</a>
</section>

<section class="slide" id="design-advice">
##Design advice
</section>

<section class="slide" id="jsf-pitfalls">
### JSF  pitfalls

- Building a JSF component from the ground:
    - is a lot of work
    - can be hard
  => Use facelets and composition to build new custom components
- Rendered clause impact on performance
- Variables exposure: build time vs render time
- Duplicate id issues
- Ajax and queues and re-render zones
- Back button management
- Server side state saving (limited by memory usage)
- ...

</section>

<section class="slide" id="jsf-pitfalls-rendered-clause-1">
### JSF rendered clause issue

- JSF rendered clause is evaluated during each phase
    - clause is evaluated 6 time per components
- Associated with a loops this can completely kill the performances of an application
</section>

<section class="slide" id="jsf-pitfalls-rendered-clause-2">
###Render clause problem

  <img src="./img/render_clause.png" />
</section>

<section class="slide" id="jsf-pitfalls-rendered-clause-3">
###Render clause solution
- Use built-time conditions
    - c:if, c:choose, c:forEach
- Bind conditions to context variables
    - use Seam factories to compute variable only once per event
- use nxu:set tag with cache property to "true"
</section>

<section class="slide" id="seam-pitfalls-1">
###Seam components design advice

- It's easy to put all logic in the Seam beans (seam book push in that direction)

but it's bad

- because the code is hard to test
- because the code is not reusable
- because it's gives packaging constraints

=> Separate UI/Logic/Storage layers
xxx-api, xxx-core, xxx-web
</section>

<section class="slide" id="seam-pitfalls-2">
### Seam pitfalls

- Scope management
    - do not use conversation scope too much
    - same for session components
    - conversation and session calls are synchronized

- Circular dependencies between Seam components

- Interceptors overhead: can be useful to bypass them
</section>

<section class="slide" id="nuxeo-pitfalls">
### Nuxeo pitfalls

- Nuxeo and ELs
    - JSF/Seam EL for layouts & widgets
    - JEXL for actions with a restricted context
    - MVEL for operations

- Override of default templates or Seam components: not advised for easier migration

</section>

<section class="slide" id="debugging">
### Debugging & Troubleshoot

- use the dev mode for refresh of xhtml templates
- use Nuxeo IDE for Seam hot reload support and debugging features

</section>

  <!-- deck.navigation snippet -->
  <a href="#" class="deck-prev-link" title="Previous">&#8592;</a>
  <a href="#" class="deck-next-link" title="Next">&#8594;</a>

  <!-- deck.status snippet -->
  <p class="deck-status">
    <span class="deck-status-current"></span> / <span
      class="deck-status-total"></span>
  </p>

  <!-- deck.goto snippet -->
  <form action="." method="get" class="goto-form">
    <label for="goto-slide">Go to slide:</label> <input type="text"
      name="slidenum" id="goto-slide" list="goto-datalist">
    <datalist id="goto-datalist"></datalist>
    <input type="submit" value="Go">
  </form>

  <!-- deck.hash snippet -->
  <a href="." title="Permalink to this slide" class="deck-permalink">#</a>

  <!-- Grab CDN jQuery, with a protocol relative URL; fall back to local if offline -->
  <script
    src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  <!-- script>window.jQuery || document.write('<script src="../deck.js/jquery-1.7.2.min.js"><\/script>')</script -->
  <script>window.jQuery || document.write('<script src="../deck.js/jquery-1.7.2.min.js"><\/script>')</script>

  <!-- Deck Core and extensions -->
  <script src="../deck.js/core/deck.core.js"></script>
  <script src="../deck.js/extensions/hash/deck.hash.js"></script>
  <script src="../deck.js/extensions/menu/deck.menu.js"></script>
  <script src="../deck.js/extensions/goto/deck.goto.js"></script>
  <script src="../deck.js/extensions/status/deck.status.js"></script>
  <script src="../deck.js/extensions/navigation/deck.navigation.js"></script>
  <script src="../deck.js-markdown/deck.markdown.js/Markdown.Converter.js"></script>
  <script src="../deck.js-markdown/deck.markdown.js/deck.markdown.js"></script>
  <script src="../deck.js/extensions/scale/deck.scale.js"></script>
  <!-- Initialize the deck -->
  <script>
    $(function() {
       $.deck('.slide');
    });
  </script>

</body>
</html>