<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js ie6" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

<title>Nuxeo training - Unit tests</title>

<meta name="description" content="Nuxeo Training - Unit testing">
<meta name="author" content="Nuxeo">
<meta name="viewport" content="width=1024, user-scalable=no">

<!-- Core and extension CSS files -->
<link rel="stylesheet" href="deck.js/core/deck.core.css">
<link rel="stylesheet" href="deck.js/extensions/goto/deck.goto.css">
<link rel="stylesheet" href="deck.js/extensions/menu/deck.menu.css">
<link rel="stylesheet"
  href="deck.js/extensions/navigation/deck.navigation.css">
<link rel="stylesheet" href="deck.js/extensions/status/deck.status.css">
<link rel="stylesheet" href="deck.js/extensions/hash/deck.hash.css">
<link rel="stylesheet" href="deck.js/extensions/scale/deck.scale.css">

<!-- Nuxeo Slide Default theme -->
<link rel="stylesheet"
  href="nuxeo-slide-template/themes/style/nuxeo-theme.css">

<!-- Nuxeo Slide with comments theme -->
<link rel="stylesheet alternate" title="with comments"
  href="nuxeo-slide-template/themes/style/nuxeo-theme-with-comments.css">

<!-- Transition theme. More available in /themes/transition/ or create your own. -->
<link rel="stylesheet"
  href="nuxeo-slide-template/themes/transition/nuxeo-transition.css">

<script src="deck.js/modernizr.custom.js"></script>
</head>

<body class="deck-container">
  <!-- Nuxeo Logo Training -->
  <div class="nuxeo-logo">
    <span class="nuxeo">nuxeo</span> <span class="slash">/</span> <span
      class="sub-part training">Trainings</span>
  </div>
</section>

<section class="slide" id="unit-test">
# Nuxeo training - Unit tests
</section>

<section class="slide" id="why-unit-test">
### Why unit test ?</h3>
#### Detect regressions 
- The faster we detect a bug, the easier it is to fix it

#### Avoid over design 
- Test Driven Development (write the test first, implement after)
- Developer user friendly

#### Simply practical
- Step by step validation
        <div class="further-info">Don't need to wait for the end
          of all the layers (core/services/ui ...etc ) to make sure your
          code is working</div>
- Refactoring friendly
- No need to restart the server to run the tests
  </section>

<section class="slide" id="how-to-unit-test-with-nuxeo">
### Nuxeo provides
#### A custom Nuxeo JUnit4 runner that:

- Launches a real Nuxeo document repository
- Allows to deploy Nuxeo bundles, components and extension points
</section>

<section class="slide" id="unit-testing">
### Unit testing
#### Unit test classes
- Should be located in <code>src/test/java</code></li>
- Should start with `Test`, for instance <code>TestBookType.java</code></li>

#### Annotations Needed
- Use the Nuxeo <code>FeatureRunner</code> junit 4 runner to handle <code>@Features</code>,<br /> <code>@Deploy</code> and <code>@LocalDeploy</code> annotations
<pre><code>@RunWith(FeaturesRunner.class)
@Features(CoreFeature.class)
@Deploy({"an.existing.bundle","another.one"})
@LocalDeploy({"bundle.name:/OSGI-INF/file.xml"})</code></pre>

</section>

  <section class="slide no-md" id="unit-testing:-features">
    <h3>
      Unit testing :
      <code>@Features</code>
    </h3>
    <ul>
      <li>A feature deploys a list of pre defined bundles 
        </p>
        <ul>
          <li>Runtime feature</li>
          <li>Core feature</li>
          <li>Platform feature</li>
          <li>Rest feature</li>
          <li>Custom feature</li>
        </ul>
      </li>
      <li><code>@Deploy</code> annotation deploys specified bundles
        <ul>
          <li>Use symbolic name of the MANIFEST.MF</li>
          <li>Maven Sync: The bundle needs to be in Maven's
            dependencies. That's why we prefer using features <br />
          <code>@Deploy("org.nuxeo.training.symbolicname")</code></li>
        </ul></li>
    </ul>
  </section>

  <section class="slide no-md">
    <h3>
      <code>@Deploy</code>
      : use
      <code>Bundle-SymbolicName</code>
      of your bundle MANIFEST.MF file
    </h3>
<pre><code>Manifest-Version: 1.0
Require-Bundle: org.nuxeo.runtime
Bundle-Vendor: Nuxeo
Bundle-Version: 1.0.0
Bundle-Name: Nuxeo Studio Extension - studio.extensions.&lt;your_Studio_project_name&gt;
Nuxeo-Component: OSGI-INF/extensions.xml
Bundle-ManifestVersion: 2
Created-By: Nuxeo Studio
<span class="bold">Bundle-SymbolicName: studio.extensions.&lt;your_Studio_project_name&gt;</span></code></pre>

<pre><code>@Deploy("studio.extensions.&lt;your_Studio_project_name&gt;")</code></pre>
    
<h4>Test that a component is loaded</h4>
<pre><code>Assert.assertNotNull(Framework.getRuntime().getComponent("studio.extensions.&lt;your_Studio_project_name&gt;"));</code></pre>
</section>

<section class="slide" id="injection">
### Nuxeo services injection
Nuxeo services and CoreSession can be injected with Google Guice injection mechanism
<pre><code>@Inject CoreSession session</code></pre>
<pre><code>@Inject AutomationService automationService</code></pre>
More generic way to get a service:
<pre><code>AutomationService automationService = 
Framework.getLocalService(AutomationService.class)</code></pre>
</section>

<section class="slide no-md" id="junit">
<h3>JUnit test method</h3>
<ul>
    <li><code>@Test</code> annotation on a method will run it as
    a test</li>
    <li>Use <code>org.junit.Assert</code> static method to assert that a value is right 
    </li>
</ul>
</section>

<section class="slide exercise" id="exercise-ide-deploy">
<img src="nuxeo-slide-template/themes/exercise.svg" alt="exercise"
      class="exercise-icon">
### Practice - Nuxeo IDE
#### Annotations
- Create a test class named `TestStudioBundle`
    - Inject a CoreSession named `session`
    - Deploy your Nuxeo studio bundle
    
#### Unit test
- Create a method `shouldDeployStudioBundle()` asserting that a component is loaded 
    - Give it a fake bundle name
    - Run your test
    - Check that your test fails
    - Replace the bundle name with your real studio bundle name
    - Re run your test
    - Check that your test succeeds
</section>

<section class="slide no-md" id="questions-annotations">
  <h2>Questions?</h2>
</section>

<section class="slide" id="nuxeo-core-api">
### Nuxeo Core API - Useful objects
#### CoreSession
- Called when you need to access the repository directly <br /> ex: Store / retrieve documents in the database
    
#### DocumentModel
- Stores document information in memory and transmits it to the CoreSession for storage
- Called when you need to access and / or update the document properties
- A document is an instance of a DocumentModel object

#### NuxeoPrincipal
- Object containing user information
- Called when you need to create / update / delete a user or a user group
</section>

<section class="slide" id="useful-methods">
### Useful methods
#### CoreSession
<code>DocumentModel createDocumentModel(String parentPath, String id, String typeName)</code><br />
Creates the DocumentModel object. Not stored nor created in the repository.
<div class="further-info">This method calls the EmptyDocumentCreated event we have seen previously in Studio.</div>

<code>DocumentModel createDocument(DocumentModel model)</code><br />
Create the document in the repository using the provided DocumentModel (instantiated with createDocumentModel).
<div class="further-info">This method calls both AboutToCreate and DocumentCreated events.</div>

<code>DocumentModel getDocument(DocumentRef docRef)</code><br />
Get a documentModel object from its ref (IdRef or PathRef).

<code>DocumentModel saveDocument(DocumentModel docModel)</code><br />
Save a doc from its model. Changes are not stored into the database yet, but marked for storage.
<div class="further-info">This method calls beforeDocumentModification and documentModified events.</div>

<code>CoreSession save()</code><br />
Calling this method stores in database all changes made to the documents.

#### DocumentModel
<code>Serializable getPropertyValue(String xpath)</code>
For instance:
<pre><code>String title = (String) doc.getPropertyValue("dc:title");</code></pre>
<code>void setPropertyValue(String xpath, Serializable value)</code>
</section>

<section class="slide exercise" id="exercise-ide-doc-creation">
<img src="nuxeo-slide-template/themes/exercise.svg" alt="exercise"
      class="exercise-icon">
### Practice - Nuxeo IDE
#### Document creation and modification
- Create a unit test named `shouldHaveAPublicationDate()` that:
    - Creates a `Book` document located in the root directory
    - Checks that the book's publication date is not null

- Create a unit test named `shouldHaveCorrectTitle()` that:
    - Creates a `Book` document located in the root directory
    - Sets a title to the book: "Da Nuxeo code" 
    - Saves the book in the repository
    - Fetches the book from the repository and checks the book title
</section>

<section class="slide" id="test-existing-automation-chains">
### Testing existing automation chains
- Use AutomationService 
    - In JUnit4, Nuxeo services injected with Google Guice <code>@Inject</code> annotation <pre><code>@inject AutomationService automationService</code></pre>
    Or <pre><code>AutomationService automationService = Framework.getLocalService(AutomationService.class)</code></pre>
- Create an <code>OperationContext</code> with the <code>CoreSession</code> and a document input and call the operation with: <pre><code>AutomationService automationService = Framework.getLocalService(AutomationService.class);
OperationContext ctx = new OperationContext();
ctx.setCoreSession(session);
ctx.setInput(myInputDocument);
automationService.run(ctx, "chainId");</code></pre>
      </li>
    </ul>
  </section>

<section class="slide exercise" id="exercise-ide-automation">
<img src="nuxeo-slide-template/themes/exercise.svg" alt="exercise"
      class="exercise-icon">
### Practice - Nuxeo IDE
#### Testing automation chains
- Create a unit test named `shouldBeBorrowedBySomeone()` that:
    - Creates a `Book` document located in the root directory
    - Calls the `borrowChain` on the Book
    - Checks that the document's lifecycle state is `borrowed`
    - Checks that the `borrowedBy` field is not null
    - Saves the document in the repository
</section>

<section class="slide" id="questions-ide-test-automation">
## Questions?
</section>

<section class="slide" id="next">
###Next?
- Back to the [training agenda](0_Introduction.html#day-4)
- [Custom operations](4.4_Custom-operations.html)
</section>

  <!-- deck.navigation snippet -->
  <a href="#" class="deck-prev-link" title="Previous">&#8592;</a>
  <a href="#" class="deck-next-link" title="Next">&#8594;</a>

  <!-- deck.status snippet -->
  <p class="deck-status">
    <span class="deck-status-current"></span> / <span
      class="deck-status-total"></span>
  </p>

  <!-- deck.goto snippet -->
  <form action="." method="get" class="goto-form">
    <label for="goto-slide">Go to slide:</label> <input type="text"
      name="slidenum" id="goto-slide" list="goto-datalist">
    <datalist id="goto-datalist"></datalist>
    <input type="submit" value="Go">
  </form>

  <!-- deck.hash snippet -->
  <a href="." title="Permalink to this slide" class="deck-permalink">#</a>

  <!-- Grab CDN jQuery, with a protocol relative URL; fall back to local if offline -->
  <script
    src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  <!-- script>window.jQuery || document.write('<script src="deck.js/jquery-1.7.2.min.js"><\/script>')</script -->
  <script>window.jQuery || document.write('<script src="deck.js/jquery-1.7.2.min.js"><\/script>')</script>


  <!-- Deck Core and extensions -->
  <script src="deck.js/core/deck.core.js"></script>
  <script src="deck.js/extensions/hash/deck.hash.js"></script>
  <script src="deck.js/extensions/menu/deck.menu.js"></script>
  <script src="deck.js/extensions/goto/deck.goto.js"></script>
  <script src="deck.js/extensions/status/deck.status.js"></script>
  <script src="deck.js/extensions/navigation/deck.navigation.js"></script>
  <script src="deck.js-markdown/deck.markdown.js/Markdown.Converter.js"></script>
  <script src="deck.js-markdown/deck.markdown.js/deck.markdown.js"></script>
  <script src="deck.js/extensions/scale/deck.scale.js"></script>
  <!-- Initialize the deck -->
  <script>
			$(function() {
				$.deck('.slide');
			});
		</script>

</body>
</html>
