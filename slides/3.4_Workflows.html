<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js ie6" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

<title>Nuxeo Training - Workflows</title>

<meta name="description" content="Nuxeo Training - Workflows">
<meta name="author" content="Nuxeo">
<meta name="viewport" content="width=1024, user-scalable=no">

<!-- Core and extension CSS files -->
<link rel="stylesheet" href="deck.js/core/deck.core.css">
<link rel="stylesheet" href="deck.js/extensions/goto/deck.goto.css">
<link rel="stylesheet" href="deck.js/extensions/menu/deck.menu.css">
<link rel="stylesheet"
  href="deck.js/extensions/navigation/deck.navigation.css">
<link rel="stylesheet" href="deck.js/extensions/status/deck.status.css">
<link rel="stylesheet" href="deck.js/extensions/hash/deck.hash.css">
<link rel="stylesheet" href="deck.js/extensions/scale/deck.scale.css">

<!-- Nuxeo Slide Default theme -->
<link rel="stylesheet"
  href="nuxeo-slide-template/themes/style/nuxeo-theme.css">

<!-- Nuxeo Slide with comments theme -->
<link rel="stylesheet alternate" title="with comments"
  href="nuxeo-slide-template/themes/style/nuxeo-theme-with-comments.css">

<!-- Transition theme. More available in /themes/transition/ or create your own. -->
<link rel="stylesheet"
  href="nuxeo-slide-template/themes/transition/nuxeo-transition.css">

<script src="deck.js/modernizr.custom.js"></script>
</head>

<body class="deck-container">

  <!-- Nuxeo Logo Training -->
  <div class="nuxeo-logo">
    <span class="nuxeo">nuxeo</span> <span class="slash">/</span> <span
      class="sub-part training">Trainings</span>
  </div>


<section class="slide" id="nuxeo-training---custom-operations">
Nuxeo Training - Workflows
================

######See documentation http://doc.nuxeo.com/x/mYSo
</section>

<section class="slide" id="agenda">
###Agenda
- Introduction
    - New workflow engine
    - Customization cycle
    - Workflow usage in Nuxeo UI
- Concepts
  - Node and transitions
  - Tasks
  - Forms and variable
  - Advanced usage
</section>

<!--
<section class="slide" id="wherewego">
### We will learn to build
<img alt="workflow-publication-start" src="img/workflow-publication-start.png" class="float-right" />
####A publication workflow where



- The workflow initiator choose the section and the validator
- The validator can accept the publication


<img alt="workflow-choose-validator" src="img/workflow-choose-validator.png"/>

<img alt="workflow-accept-publication" src="img/workflow-accept-publication.png" />


</section>
-->
    
<section class="slide" id="newwfengine">
###Introduction
####New WF engine 
    
- Based on existing infrastructure and using existing features
    - **Automation chains**, powered by Content Automation
    - **Layouts**, dynamic forms using the layout system
    - **Notifications**, using the  freemarker templating  system
    - **Document**, Stored as a structure of documents
    - **Content views**
    
####A new graph editor in Studio 
<img alt="workflow-publication-graph" src="img/workflow-publication-graph.png"
/>

</section>



<section class="slide">
Demo
----------------------------------------
</section>

<!--
<section class="slide">
Demo2 - holiday management
-----------------------------------------
</section>
-->
    
<section class="slide" id="customization-process">
### Customization cycle
#### In Studio, we define the graph and the model 
 - Creation of a new workflow feature
 - Graph design
 - Nodes configuration <div class="further-info">including forms and automation chains if required</div>
 
#### In Nuxeo UI, we launch the workflows
 - A workflow template ( model )
 - Using this template we start a workflow instance on a document.
 - Start the workflow from the UI using “Workflow Process” widget or using the StartWorkflow operation.
</section>
    
<section class="slide" id="innuxeo">
###Workflow usage in Nuxeo UI
####Summary tab
- Available workflows or started workflows<img alt="workflow-summary-availables" src="img/workflow-summary-availables.png" class="float-right" />

####Workflow tab 
- Running workflows
- All waiting task for this doc + layout + actions
    
    <img alt="workflow-dashboard" src="img/workflow-summary-task.png" class="float-center" />
    
####Dashboard
- Waiting tasks for the user + link to the doc 
                
<img alt="workflow-dashboard" src="img/workflow-dashboard.png" class="float-right" />       
    
    </section>

    <section class="slide" id="innuxeo-admin">
###Workflow usage in Nuxeo UI



####Admin Center: Workflow templates and instances
        
- Studio generates workflow configurations
    - As xml
    - At startup, generates documents (templates) -> availables  workflows

- When starting a WF
        
    - New instance created as documents
    - Copy of the template
    - Can restrict access with ACL
<img alt="workflow-admincenter" src="img/workflow-admincenter.png" class="float-right" />

</section>



<section class="slide" id="concepts">
Nuxeo Workflow Concepts
--------------------------------------
</section>
<section class="slide" id="new-workflow">
###Create a new Workflow in Studio 

<img alt="workflow-definition" src="img/workflow-creation.png" class="float-right" />
####New Workflow Definition
- Template that will be used in DM to start workflows on documents
    
    - ID (must be unique) 
        - id of the declared workflow template
        - Useful for starting a workflow with automation
    - label
        - Displayed in Nuxeo in the drop down that launches a workflow
        - Supports i18n
    - description
        - displayed beside the dropdown that launches a workflow, then the corresponding workflow is selected
</section>

<section class="slide" id="workflow-definition">
###Definition Tab


- Label
- Description
- Icons
<img alt="workflow-definition" src="img/workflow-definition.png"/>
</section>
 
     <section class="slide" id="workflow-var">
###Variables Tab
####Information that can be accessed during the workflow

- Store data that comes from user forms or they are computed by automation chains
- Available in the automation context using the 
predefined object WorkflowVariables[]
- *Similar with these, we can define on every node some Nodes Variables available in the context of that node using the predefined object NodeVariables[]*
         
<img alt="workflow-variables" src="img/workflow-variables.png" class="float-center" />

</section>
 
    
 <section class="slide" id="enablements">
###Availability Tab

####Conditions in which the workflow will be available:
<img alt="workflow-availability" src="img/workflow-availability.png" class="float-right" />

- A workflow can be enabled according to
     - document types
     - the current lifecycle state
     - Permissions (ie. read/write right)
     - Facets
     - Path
     - etc.
</section>
 
<section class="slide" id="graph-editor-graph">
###Graph editor Tab
####Graphical drag and drop workflow editor
    


![a screen shot of the graph editor in studio](img/workflow-graph-editor.png)
</section>
    
<section class="slide" id="main-concepts">
###Workflow Main Concepts

####Graph  <img alt="workflow-graph-node" src="img/workflow-graph-node.png" class="float-right" /> 
- The graph is the definition of your process
    - start node
    - one or more end nodes
    - nodes linked by transitions 

####Nodes
- A node is an element of action
- Can be a simple node or a task


####Transitions
- Two nodes are linked by a transition
- A condition set on the transition enables to know if it is possible to go from one node to another one linked via a transition.
    
</section>    
    
    
<section class="slide exercise" id="workshop-simple-workflow">
<img src="nuxeo-slide-template/themes/exercise.svg" alt="exercise"
      class="exercise-icon">    
###Exercise: Simple Workflow

Even if we didn't discuss yet all the workflow concepts , you can build a simple workflow !
            
- Create a simple workflow having only the Start and the Stop nodes
- Make sure this workflow can be started only on documents of type File and only if the user has the Read and Write permissions on the current document
- After deploying the workflow in Nuxeo go to the Workflow tab in Admin Center and check that your workflow model is there
- Automatically start the workflow “SerialDocumentReview” each time a document of type “Note” is created
    - use an EventHandler
    - use the StartWorkflow operation        
</section>    
    
    
    
<section class="slide" id="nodes-and-transitions">
Nodes and transitions
---------------------------------
</section>
 
    
<section class="slide" id="node-general">
###Node Definition

####Node = element of action
- On a node, something happens
    - human task
    - server task as an automated set of actions
- A node = set of properties to determine what happens on the node regarding
    - automated actions
    - notifications
    - graph behavior
    - task creation
    - etc.
    
#### Two kind of nodes
- Automated **node**
    - require no user intervention
    - Eg. A node to send an email, publish a document
- User **task**
    - require a user intervention to resume the workflow: Eg. Accept/Reject

####Structural nodes 
- Any automated node or user task can also be a structural node)

</section>
    
<section class="slide" id="node-configuration">         
###Node Configuration 
        
        
####Popup editor
<img alt="Studio node edition form" src="img/workflow-node-general-tab.png" />

- General
- Node variables
- Task form ( only if the node is of type “Task” )
- Transitions
    
####General tab
- General information:  title, directive
- Input operation chain
    - The automation chain you specify here will be executed just before the workflow engine enters the node
- Output operation chain
    - The automation chain you specify here will be executed just before the workflow engine leaves the node.
- The documents following the workflow are set by the engine as the input documents when these chains are invoked . This chains are executed using an unrestricted session!!  
    
</section>
 

<section class="slide" id="node-variable">
###Node Configuration
####Variables tab
- Store information that can be accessed in the context of the current node during the workflow
- Store data that comes from user forms or computed by automation chains
- Available in the predefined object
    - <code>NodeVariables["nodeVariableName"]</code>
- predefined variable called “assignees” on every task node
    - Used by <code>Compute Additional Assignees = NodeVariables["assignees"]</code>
- Variables shared within a node of a workflow instance
- Accessible in the task layouts
- Available from notification templates
</section>
    
<section class="slide" id="Transition">
###Node Configuration
####Transition Tab
    
- For every transition : an endpoint with the name of the transition, from which you will be able to pull the arrow to connect nodes
- Transition
    - name: only displayed in the graph, and used internally by the engine
    - Condition: condition the workflow engine evaluates in order to know which are the next nodes to be executed after the current one is done.
    - Chain: The automation chain will be executed when the workflow engine goes into this transition
    
<img alt="workflow-transition-arrow" src="img/workflow-transition-arrow.png"/>
 </section>

    
<section class="slide" id="Transition-condition">
###Node Configuration
####Condition
- Condition the workflow engine evaluates in order to know which are the next nodes to be executed after the current one is done.
    - default value for the condition is “true”
    - all the transitions having the corresponding condition evaluated to “true” are executed
    - you have access at all the workflow context variables ( including Node and Workflow variables)
    - the default condition related to a task button is 
<code>NodeVariables"button" ==”idOfTheClickedBtn”</code>
- Fork
    - Ex. Two transitions having the condition evaluated to “true” = Fork two branches
- Conditional nodes 
    - Ex. On a node having two transition,the conditions could be simply:
<code>WorkflowVariables["status"] == "done" and WorkflowVariables["status"] != "done" </code>
 </section>

    
    
<section class="slide exercise" id="workshop-nodes-transition">
<img src="nuxeo-slide-template/themes/exercise.svg" alt="exercise"
      class="exercise-icon">
###Exercise: Nodes and transitions
First we will create an empty workflow

- Create a simple workflow having only the Start and the Stop nodes (mandatory nodes)
- Make sure this workflow can be started only on documents of type File and only if the user has the Read and Write permissions on the current document
- After deploying the workflow in Nuxeo go to the Workflow tab in Admin Center and check that your workflow model is there
- Start the workflow from a `Book` document, the workflow should do nothing
- Add a new node that
  - call a chain
  - publish the document in a existing section `/default-domain/sections/section1`
</section>



<section class="slide" id="tasks">
Tasks
--------
</section>
 
 <section class="slide" id="node-Task">
###A special Node: Task
     
####When the system requires a user intervention to resume the workflow
- Give some information through a form and click on a button 
     - Accept/Reject
     - confirm
     - notify
     - transform etc.
         
- Can have one or multiple assignees
- Wait for an assignee action before going into a transition
- Can set a form to be filled by the assignee
- Can bind user actions to transitions to take
- The form set values to
  - Workflow variables
  - Task variables  
</section>


<section class="slide" id="task-config">
###Task Configuration
####General Tab
<img alt="Studio node edition form" src="img/workflow-node-general.png" class="float-right" />

- General information:  title, directive
- Due date
    - set here a scripted expression (MVEL syntax)
    - the dueDate of a task will be  dynamically computed  from this expression when  the workflow is run
- Assignment : static or dynamic
- Notification: send a custom notification when a task is assigned
- Plugin in custom business logic : input & output automation chains
- Security: grant specific permissions to the task assignees on the document following the workflow (automatically removed by the workflow engine once the task is completed)
</section>

<section class="slide" id="task-config-assignees">
###Task Configuration
####General tab: Assignees
            
<img alt="Studio node edition form" src="img/workflow-node-assignee.png" class="float-right" />
    
- Assignees
    - You can add here static assignees, either users or groups, one per input field (click on "add" to add more than one)
    - You can  prefix users by "user:" like user:jack and groups by "group:" like group:validators.
- Compute additional assignees
    - You can set here a scripted expression (MVEL syntax) so as to determine how the assignees on that task will be computed at runtime
    - You have access to some useful variables in the context, like the WorkflowVariables, NodeVariables, Current User and others
</section>

    
  <section class="slide" id="task-config-automation">
###Task Configuration
####General tab: Automation
<img alt="Studio node edition form" src="img/workflow-node-general-automation.png" class="float-right" />

- Input operation chain
    - The automation chain you specify here will be executed just before the workflow engine enters the node
- Output operation chain
    - The automation chain you specify here will be executed just before the workflow engine leaves the node.
- The documents following the workflow are set by the engine as the input documents when these chains are invoked . This chains are executed using an unrestricted session!!  
  </section>
  
  <section class="slide" id="task-config-notifications">
###Task Configuration
<img alt="Studio node edition form" src="img/" class="float-right" />
#### General tab: Notifications 
- Mail Notifications
      - Specify here the mail template that is going to be used for generating the mail to be sent to the task assignees
      - if no template is selected, the task assignees are not notified
      - Custom variables <div class="further-info">can be used in a mail template in this specific case</div>
<pre><code>
${workflowStartTime} 
${workflowInitiator} 
${WorkflowVariables} 
${NodeVariables}
${workflowDocuments} 
..
</code></pre>

Eg:
<pre><code>A task on the document ${workflowDocuments[0].dublincore.title} has been assigned to you by ${workflowInitiator}.</code></pre>
</section>
    
   
    
<section class="slide" id="task-config-form">
###Task Configuration
####Form tab

- Form layout
    <img alt="workflow-task-form" src="img/workflow-task-form.png" class="float-right" />
    - Configure the form that will be displayed to the user for processing the task
    - Specify which fields have to fill
    - Layout edition works as usual
        - pickup the fields on the right
        - Choose between system properties, workflow variables and node variables. 
        - If you need the user to set/see some workflow or node variables 
            - just drag and drop them on the form
            - the engine will automatically save them when the form is submitted 
            - you can use these them later
</section>
 <section class="slide" id="task-config-buttons">
###Task Configuration
####Form tab: Buttons
     
- Configure the buttons to be displayed for submitting the task form
- Buttons can be linked to transitions with <code>NodeVariable["Button"] == "buttonId"</code> 
     
<img alt="workflow-task-form" src="img/workflow-task-buttons.png" class="float-center" />

- Id
    - stored in the  built-in NodeVariable called "button" 
    - can be used for instance to express conditions for knowing which transition the workflow engine should follow after the current node is done
- Label of the button (supports i18n)
- Filter
    - Filter to hide or display the button on some conditions
    - Work only starting from 5.7. (an action filter)
- Generate the condition for transition 
    - checked by default when you add a line
    - helper so that a transition corresponding to the button is automatically declared on the Transitions tab
</section>

    

<section class="slide exercise" id="exercise-simple-task">
<img src="nuxeo-slide-template/themes/exercise.svg" alt="exercise"
      class="exercise-icon">
###Exercise: Simple task
Create a simple workflow to validate the publishing of a document by Administrator

- the document will be published at a predefined existing location ( manually go and create a section called *Public* in Sections, having the path `/default-domain/sections/Published`)
- this workflow should be available only on the documents of type `Book`
- the Administrator can either validate or reject the publication
(use the predefined `Accept/Reject` task)
- the due date displayed for the Administrator should be the current date.
</section>


<section class="slide" id="variables">
Workflow Variables
---------------------------------
</section>
<section class="slide" id="workflow-variables">
###Workflow variables
    
####2 types of variables
- Nodes variables (defined on a node and accessible on the node scope)

- Workflow variable
    - Defined at workflow level, accessible from any node
    - Shared within the whole instance of the workflow
    - Available in the automation context <code>WorkflowVariables["wfVariableName"]</code>
    - Can be use in the *Compute additional assignees* of a task
    - Accessible in the task layouts
    - Available from notification templates
    - Has a type: string, float, blob etc.
    - Can be a date picked up in a calendar, a file, a constrained value etc.
    
</section>


<section class="slide" id="built-variables">
###Built-in Variables
####Available to be used in

- chains run on the nodes (Input chain, output chain, transition chains)  
- when expression the condition for a transition
- Additional Task Assignees ( if the expression is resolved to a user or group)
- Due date expression  ( if the expression is resolved to a date)

####List of built-in variables
- *WorkflowVariables* and *NodeVariables*  ( hashmaps), used like this: NodeVariables[“myNodeVar”]
- *workflowInitiator*
- *workflowStartTime* 
    - Time when the workflow was started
    - useful for exemple when computing a due date (Due date expression: workflowStartTime.days(8))
- *Documents/document* documents bound to the workflow
    - Those documents are also set as input of chains executed.
- *button* button id that was clicked for processing the task, if the current node is a task node
- *nodeId*
- *nodeStartTime* Time the node was started, useful for exemple when computing a due date (Due date expression: nodeStartTime.days(8))
- *nodeEndTime*
- *nodeLastActor* Last actor on the node. Useful for instance to know who closed a task when the task was assigned to a group
- http://doc.nuxeo.com/x/EQGw
 </section>
    
<section class="slide" id="assignees">
###Task Assignment
#### To a computed variable
- Use input chain to set a Node variable
- Leverage vocabulary tables to provide a quick mapping interface between some users and some others (Jack is John's manager)
    
#### To the workflow initiator
- *workflowInitiator* variable
- See also *nodeLastActor*
    
####To a static user/group
- See "group:…" or "user:..."notation 
- Ex: assignment to hr_manager group in the workflow

</section>

            
<section class="slide" id="set-workflow">
###How to set workflow and node variables
####From the task form
- The engine will automatically save them when the form is submitted 
    
####From automation chains
- Using *Workflow Context > Set Workflow Variable* <code>SetWorkflowVar</code> and *Set Node Var* <code>SetNodeVar</code> operations
- For instance when the task form should display some pre-initialized variables
    
    ![A task form with a preinitialized field](img/workflow-preinit-var.png)

</section> 

<section class="slide exercise" id="workflow-exercise">
<img src="nuxeo-slide-template/themes/exercise.svg" alt="exercise"
      class="exercise-icon">
###Exercise: Task Form, Variables
Let's now create a more complicated workflow to validate the publication of a document.
We want to publish a document at a chosen location,
but the publication must be validated by a chosen user (validator) in order to occur.
If user reject the publication, the workflow initiator can choose another validator or cancel its request

- This workflow should be available only on the documents of type `Book` and only if the current user is a member of *administrators* group
- The first task of the workflow is assigned to the user who started the workflow.
  - This user has to choose here the validator and where he wants to publish the doc. use the widget `Single user suggestion`
  - Use `Single Document Suggestion` widget type  to choose the section, use the page provider `default_section_suggestion`
- The chosen validator can approve the publication or reject ( use an  approve/reject task). ( in serial way) .
  They both need to submit a *comment* when approving or rejecting the task ( mandatory).
  They both need temporary access to the document being published ( assuming that they don't necessarily have them ).
  Also he need to know where the doc will be published ( but this info must be displayed in Read only).
  - notify the validator when a task was assigned to him ( only if you have a mail server configured ) 
  - for the comment, use a NodeVariable called *comment*
</section>

<section class="slide" id="advanced-wf">
##Advanced concepts and usage
</section>

 <section class="slide" id="Storage-infos">
###How does Nuxeo stores Workflows ?
- Workflow models and instances are stored as documents of type DocumentRoute 
- default path for workflow models: /document-route-models-root/
     - default path for workflow instances : example
/default-domain/document-route-instances-root/2012/12/12
- Workflow nodes are stored as documents of type RouteNode
     - default path for workflow nodes: example:
/document-route-models-root/SerialDocumentReview/  
- Tasks are stored as documents of type TaskDoc  
     - default path for tasks docs: /tasks-root/
- Type of task document used by the workflow is configurable in Studio 
- Each workflow step history is stored in Audit
</section> 
    
<section class="slide" id="chains">
###Where can I plug Automation chains ?

- Attached to each transition
- Attached to node input and output
- The input documents are the documents bound to the workflow
- Available with the variable *Documents*
- Transition chains executed before output chains
<blockquote>These chains are executed using an unrestricted session!!</blockquote>
</section>

<!--
<section class="slide" id="security">
###How can I manage security during a workflow?
- Automatically add/remove rights to assignee
  - from the task definition
- Operation SetACL
</section>

<section class="slide" id="tracability">
###Tracability

- Log with audit with automation audit
- Can be used for stats

</section>
-->
<section class="slide" id="startworkflow">
###How can I automatically start a workflow?
 - From a user action
 - From a event handler
 - From a REST call
 
Use the operation *Workflow Context > Start workflow*
</section>

<section class="slide" id="end">
Thank you
------------
  </section>

  <!-- deck.navigation snippet -->
  <a href="#" class="deck-prev-link" title="Previous">&#8592;</a>
  <a href="#" class="deck-next-link" title="Next">&#8594;</a>

  <!-- deck.status snippet -->
  <p class="deck-status">
    <span class="deck-status-current"></span> / <span
      class="deck-status-total"></span>
  </p>

  <!-- deck.goto snippet -->
  <form action="." method="get" class="goto-form">
    <label for="goto-slide">Go to slide:</label> <input type="text"
      name="slidenum" id="goto-slide" list="goto-datalist">
    <datalist id="goto-datalist"></datalist>
    <input type="submit" value="Go">
  </form>

  <!-- deck.hash snippet -->
  <a href="." title="Permalink to this slide" class="deck-permalink">#</a>

  <!-- Grab CDN jQuery, with a protocol relative URL; fall back to local if offline -->
  <script
    src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  <!-- script>window.jQuery || document.write('<script src="deck.js/jquery-1.7.2.min.js"><\/script>')</script -->
  <script>window.jQuery || document.write('<script src="deck.js/jquery-1.7.2.min.js"><\/script>')</script>


  <!-- Deck Core and extensions -->
  <script src="deck.js/core/deck.core.js"></script>
  <script src="deck.js/extensions/hash/deck.hash.js"></script>
  <script src="deck.js/extensions/menu/deck.menu.js"></script>
  <script src="deck.js/extensions/goto/deck.goto.js"></script>
  <script src="deck.js/extensions/status/deck.status.js"></script>
  <script src="deck.js/extensions/navigation/deck.navigation.js"></script>
  <script src="deck.js-markdown/deck.markdown.js/Markdown.Converter.js"></script>
  <script src="deck.js-markdown/deck.markdown.js/deck.markdown.js"></script>
  <script src="deck.js/extensions/scale/deck.scale.js"></script>
  <!-- Initialize the deck -->
  <script>
			$(function() {
				$.deck('.slide');
			});
		</script>

</body>
</html>
