<!DOCTYPE html>
<!--[if lt IE 7]> <html class="no-js ie6" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js ie7" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js ie8" lang="en"> <![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en">
<!--<![endif]-->
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

<title>Nuxeo Training - Workflows</title>

<meta name="description" content="Nuxeo Training - Workflows">
<meta name="author" content="Nuxeo">
<meta name="viewport" content="width=1024, user-scalable=no">

<!-- Core and extension CSS files -->
<link rel="stylesheet" href="deck.js/core/deck.core.css">
<link rel="stylesheet" href="deck.js/extensions/goto/deck.goto.css">
<link rel="stylesheet" href="deck.js/extensions/menu/deck.menu.css">
<link rel="stylesheet"
  href="deck.js/extensions/navigation/deck.navigation.css">
<link rel="stylesheet" href="deck.js/extensions/status/deck.status.css">
<link rel="stylesheet" href="deck.js/extensions/hash/deck.hash.css">
<link rel="stylesheet" href="deck.js/extensions/scale/deck.scale.css">

<!-- Nuxeo Slide Default theme -->
<link rel="stylesheet"
  href="nuxeo-slide-template/themes/style/nuxeo-theme.css">

<!-- Nuxeo Slide with comments theme -->
<link rel="stylesheet alternate" title="with comments"
  href="nuxeo-slide-template/themes/style/nuxeo-theme-with-comments.css">

<!-- Transition theme. More available in /themes/transition/ or create your own. -->
<link rel="stylesheet"
  href="nuxeo-slide-template/themes/transition/nuxeo-transition.css">

<script src="deck.js/modernizr.custom.js"></script>
</head>

<body class="deck-container">

  <!-- Nuxeo Logo Training -->
  <div class="nuxeo-logo">
    <span class="nuxeo">nuxeo</span> <span class="slash">/</span> <span
      class="sub-part training">Trainings</span>
  </div>


<section class="slide" id="nuxeo-training---custom-operations">
Nuxeo Training - Workflows
================

######See documentation http://doc.nuxeo.com/x/mYSo
</section>

<section class="slide" id="wherewego">
###Workflows. What we want to do
<img alt="workflow-publication-start" src="img/workflow-publication-start.png" class="float-right" />
####At the end of the course:

A publication workflow where



- The workflow initiator choose the section and the validator
- The validator can accept the publication

<img alt="workflow-publication-graph" src="img/workflow-publication-graph.png" class="float-right" />

<img alt="workflow-choose-validator" src="img/workflow-choose-validator.png"/>

<img alt="workflow-accept-publication" src="img/workflow-accept-publication.png" />


</section>

<section class="slide" id="agenda">
###Agenda
- Introduction
- Concepts
  - Node transitions
  - Tasks
  - Forms and variable
  - Advanced usage
</section>


<section class="slide no-md" id="newwfengine">
<div class="sticker">Available since Nuxeo 5.6</div>
<h3>New WF engine</h3>
<p>Based on existing infrastructure</p>
<ul>
      <li>Automation<div class="further-info">Powered by Content Automation</div></li>
      <li>Layout <div class="further-info">Dynamic forms using the layout system</div></li>
      <li>Notification <div class="further-info">Workflow notifications – using the  freemarker templating  system</div></li>
      <li>Document <div class="further-info">Stored as a structure of documents</div></li>
      <li>Content views</li>
      <li>Lifecycle</li>
      <li>Task</li>
      <li class="slide">A Studio graph editor</li>
</ul>
</section>





<section class="slide">
Demo1 - default serial workflow
----------------------------------------
</section>


<section class="slide">
Demo2 - holiday management
-----------------------------------------
</section>

<section class="slide" id="innuxeo">
###Workflow usage in Nuxeo UIio

####Summary tab of a doc
  - choose a workflow and start it <img alt="workflow-summary-availables" src="img/workflow-summary-availables.png" class="float-right" />
  - currently started workflows
  - Waiting task for this doc + layout + actions

####Workflow tab of a doc
  - Running workflows
  - All waiting tasks

####Dashboard
<img alt="workflow-dashboard" src="img/workflow-dashboard.png" class="float-right" />

  - Waiting tasks for the user + link to the doc

####Admin Center
  - Workflow templates availables

 ![workflow-summary-task](img/workflow-summary-task.png)
</section>

<section class="slide" id="customization-process">
###Nuxeo Studio versus Nuxeo CAP/DM
#### In Studio, we define the graph and the model 
 - Creation of a new workflow feature
 - Graph design
 - Nodes configuration <div class="further-info">including forms and automation chains if required</div>
 
#### In Nuxeo CAP/DM, we launch the workflows
 - A workflow template ( model )
 - Using this template we start a workflow instance on a document.
 - Start the workflow from the UI using “Workflow Process” widget or using the StartWorkflow operation.
</section>


<section class="slide" id="graph-editor">
###Graph editor
![a screen shot of the graph editor in studio](img/workflow-graph-editor.png)
</section>


<section class="slide" id="templates">
###Workflow templates and instances
<img alt="workflow-admincenter" src="img/workflow-admincenter.png" class="float-right" />

Studio generates workflow configurations

- As xml
- At startup, generates documents (templates) -> availables  workflows

When starting a WF

- New instance created as documents
- Copy of the template
- Can restrict access with ACL

</section>




<section class="slide" id="concepts">
Nuxeo Workflow Concepts
--------------------------------------
</section>


<section class="slide" id="nodes-and-transitions">
Nodes and transitions
---------------------------------
</section>

<section class="slide" id="workflow-definition">
###Workflow definition
<img alt="workflow-definition" src="img/workflow-definition.png" class="float-right" />

- Feature id
- Label
- icons
</section>
 
 <section class="slide" id="enablements">
###Availability
<img alt="workflow-availability" src="img/workflow-availability.png" class="float-right" />

Like actions, event handlers, tabs, etc ... 

A workflow can be enabled according to

- doctypes
- the current lifecycle state
- the permission
- etc ...

![Available workflow to start in the summary tab](img/workflow-summary-availables.png)
</section>
 
 <section class="slide" id="Nodes">
###Nodes
<img alt="workflow-graph-node" src="img/workflow-graph-node.png" class="float-right" />

Node: square, a step of the workflow

- Node
- Start node
- End node
- Fork 2 ways
- Fork 3 ways
- A node has transitions

Available nodes are only examples/samples
</section>

<section class="slide" id="editnode">
###Node edition
<img alt="Studio node edition form" src="img/workflow-node-definition.png" class="float-right" />

- Label
- Input operation chain <div class="further-info">The automation chain you specify here will be executed just before the workflow engine enters the node</div>
- Output operation chain <div class="further-info">The automation chain you specify here will be executed just before the workflow engine leaves the node</div>
</section>

<section class="slide" id="Transition">
###Transitions
<img alt="workflow-transition-arrow" src="img/workflow-transition-arrow.png" class="float-right" />

 - Transition name <div class="further-info">Name is only displayed in the graph, and used internally by the engine</div>
 - Next routes that can take a workflow
 - From one node to another. point > arrow <div class="further-info">For every transition : an endpoint with the name of the transition, from which you will be able to pull the arrow to connect nodes</div>
 - Can execute automation chains <div class="further-info">The chain will be executed when the workflow engine goes into this transition</div>
 - Condition to follow the transition (or not) <div class="further-info">This is the condition the workflow engine evaluates in order to know which are the next nodes to be executed after the current one is done.</div>
 - Parallel: follow all the transitions evaluated to *true*
 
 <img alt="workflow-node-transitions" src="img/workflow-node-transitions.png" />
 </section>

<section class="slide exercise" id="workshop-nodes-transition">
<img src="nuxeo-slide-template/themes/exercise.svg" alt="exercise"
      class="exercise-icon">
###Exercise: Nodes and transitions
- Create a simple workflow having only the Start and the Stop nodes
- Make sure this workflow can be started only on documents of type File and only if the user has the Read and Write permissions on the current document
- After deploying the workflow in Nuxeo go to the Workflow tab in Admin Center and check that your workflow model is there
- Start the workflow from a `Book` document, the workflow should do nothing
- Add a new node that
  - call a chain
  - publish the document in a existing section `/default-domain/sections/section1`
</section>




<section class="slide" id="tasks">
Tasks
--------
</section>
 
 <section class="slide" id="Task">
###A special Node: Task
*Require a user intervention to resume the workflow: Eg. Accept/Reject*

- has assignees
- wait for an assignee action before going into a transition
- can set a form to be filled by the assignee
- can bind user actions to transitions to take
- the form set values to <div class="further-info">set ?</div>
  - workflow variables
  - task variables  
</section>

<section class="slide" id="studio-task">
###Task in Studio
<img alt="workflow-assignees" src="img/workflow-assignees.png" class="float-right" />

- General information:  title, directive
- Assignment : static or dynamic
  - Assignees <div class="further-info">You can ad here static assignees, either users or groups, one per input field (click on "add" to add more than one). You can  prefix users by "user:" like user:jack and groups by "group:" like group:validators.</div>
  - Compute additional assignees <div class="further-info">You can set here a scripted expression (MVEL syntax) so as to determine how the assignees on that task will be computed at runtime. You have access to some useful variables in the context, like the WorkflowVariables , NodeVariables , Current User and others</div>
- Due Date <div class="further-info">set here a scripted expression (MVEL syntax) and the dueDate of a task will be  dynamically computed  from this expression when  the workflow is run</div>
- Notification <div class="further-info">send a custom notification when a task is assigned</div> 
- Plugin in custom business logic : input & output automation chains
- Automatic permission grant to assignees <div class="further-info">Grant specific permissions to the task assignees on the document following the workflow ( automatically removed by the workflow engine once the task is completed)</div>
<img alt="workflow-node-configuration" src="img/workflow-node-configuration.png" />
</section>

<section class="slide" id="chains">
###Automation chains

- Attached to each transition
- Attached to node input and output
- The input documents are the documents bound to the workflow
- Available with the variable *Documents*
- transition chains executed before output chains
<blockquote>These chains are executed using an unrestricted session!!</blockquote>
</section>

 <section class="slide" id="notifications">
###Mail Notifications

#### Built-in 
- Notification configuration to assignee, with template choice
- Leverage the workflow variables in the freemarker template
- If no template is selected, the task assignees are not notified
- Custom variables <div class="further-info">can be used in a mail template in this specific case</div>

<pre><code>
${workflowStartTime} 
${workflowInitiator} 
${WorkflowVariables} 
${NodeVariables}
${workflowDocuments} 
..
</code></pre>

Eg:
<pre><code>A task on the document ${workflowDocuments[0].dublincore.title} has been assigned to you by ${workflowInitiator}.</code></pre>
</section>

 <section class="slide" id="notifications-custom">
###Mail Notifications
#### Custom
- Sending a custom email in output chain or input chain, using *Send Email* operation
- Also uses freemarker templates --> easy to maintain
</section>


<section class="slide exercise" id="exercise-simple-task">
<img src="nuxeo-slide-template/themes/exercise.svg" alt="exercise"
      class="exercise-icon">
###Exercise - Simple task
Create a simple workflow to validate the publishing of a document by Administrator

- the document will be published at a predefined existing location ( manually go and create a section called *Public* in Sections, having the path `/default-domain/sections/Published`)
- this workflow should be available only on the documents of type `Book`
- the Administrator can either validate or reject the publication
(use the predefined `Accept/Reject` task)
- the due date displayed for the Administrator should be the current date.
</section>


<section class="slide" id="variables-task-form">
Variables and Task form
---------------------------------
</section>
<section class="slide" id="workflow-variables">
###Workflow variables
- Variables shared within the whole instance of the workflow
- Available in the automation context <code>WorkflowVariables["wfVariableName"]</code>
- Can be use in the *Compute additional assignees* of a task
- Accessible in the task layouts
- Available from notification templates
</section>

<section class="slide" id="nodevariable">
###Node variables
- Variables shared within a node of a workflow instance
- Available in the automation context <code>NodeVariables["nodeVariableName"]</code>
- Can be use in the *Compute additional assignees* of a task
- Accessible in the task layouts
- Available from notification templates
</section>

<section class="slide" id="tasklayout">
###Task form
<img alt="workflow-task-form" src="img/workflow-task-form.png" class="float-right" />

- Available for task only
- Form displayed to the assignee <div class="further-info">Configure here the form that will be displayed to the user for processing the task. You can specify which fields have to filled.</div>
- Edit Workflow and Node variables <div class="further-info">Layout edition works as usual (you pickup the fields on the right, here you have the choice between system properties, workflow variables and node variables. If you need the user to set/see some workflow or node variables, just drag and drop them on the form, the engine will automatically save them when the form is submitted and you can use these them later</div>
- Buttons that can be linked to transitions with <code>NodeVariable["Button"] == "buttonId"</code> <div class="further-info">Configure the buttons to be displayed for submitting the task form</div>
  - Id <div class="further-info">is stored in the  built-in NodeVariable called"button" and can be used for instance to express conditions for knowing which transition the workflow engine should follow after the current node is done.</div>
  - Label <div class="further-info">Label of the button, supports i18n.</div>
  - Filter <div class="further-info">Filter to hide or display the button on some conditions. Work only starting from 5.7. ( an action filter)</div>
  - Generate the condition for transition <div class="further-info">this column, checked by default when you add a line, is a helper so that a transition corresponding to the button is automatically declared on the Transitions tab</div> 

</section>

<section class="slide" id="built-variables">
###Built-in Variables
####Available to be used in:

- chains run on the nodes (Input chain, output chain, transition chains)  
-  when expression the condition for a transition
- Additional Task Assignees ( if the expression is resolved to a user or group)
- Due date expression  ( if the expression is resolved to a date)

####These ones: http://doc.nuxeo.com/x/EQGw

<div class="further-info">
- *WorkflowVariables* and *NodeVariables*  ( hashmaps), used like this: NodeVariables[“myNodeVar”]
- *workflowInitiator*
- *workflowStartTime* Time when the workflow was started <div class="further-info">useful for exemple when computing a due date (Due date expression: workflowStartTime.days(8))</div>
- *Documents/document* documents bound to the workflow. Those documents are also set as input of chains executed.
- *button* button id that was clicked for processing the task <div class="further-info">if the current node is a task node</div>
- *nodeId*
- *nodeStartTime* Time the node was started <div class="further-info">useful for exemple when computing a due date (Due date expression: nodeStartTime.days(8))</div>
- *nodeEndTime*
- *nodeLastActor* Last actor on the node. Useful for instance to know who closed a task when the task was assigned to a group.
</div>
</section>

<section class="slide" id="assignees">
###Task - Assignment
#### to a static user/group
- See "group:…" or "user:..."notation 
- Ex: assignment to hr_manager group in the workflow

#### To the workflow initiator
- *workflowInitiator* variable
- See also *nodeLastActor*

#### To a computed variable
- Use input chain to set a Node variable
- Leverage vocabulary tables to provide a quick mapping interface between some users and some others (Jack is John's manager)
</section>

<section class="slide" id="variables-from-chain">
###Set Workflow and Node variables
####From the task form
Automatically saved when the form is submitted 

####From automation chains
- *Workflow Context > Set Workflow Variable* <code>SetWorkflowVar</code> and *Set Node Var* <code>SetNodeVar</code> operations
- To pre-initialize variables <div class="further-info">For instance when the task form should display some pre-initialized variables</div>

![A task form with a preinitialized field](img/workflow-preinit-var.png)
</section>

<section class="slide exercise" id="workflow-exercise">
<img src="nuxeo-slide-template/themes/exercise.svg" alt="exercise"
      class="exercise-icon">
###Exercise Task Form, Variables
Let's now create a more complicated workflow to validate the publication of a document.
We want to publish a document at a chosen location,
but the publication must be validated by a chosen user (validator) in order to occur.
If user reject the publication, the workflow initiator can choose another validator or cancel its request

- This workflow should be available only on the documents of type `Book` and only if the current user is a member of *administrators* group
- The first task of the workflow is assigned to the user who started the workflow.
  - This user has to choose here the validator and where he wants to publish the doc. use the widget `Single user suggestion`
  - Use `Single Document Suggestion` widget type  to choose the section, use the page provider `default_section_suggestion`
- The chosen validator can approve the publication or reject ( use an  approve/reject task). ( in serial way) .
  They both need to submit a *comment* when approving or rejecting the task ( mandatory).
  They both need temporary access to the document being published ( assuming that they don't necessarily have them ).
  Also he need to know where the doc will be published ( but this info must be displayed in Read only).
  - notify the validator when a task was assigned to him ( only if you have a mail server configured ) 
  - for the comment, use a NodeVariable called *comment*
</section>

<section class="slide" id="advanced-wf">
##Advanced concepts and usage
</section>

<section class="slide" id="security">
###Security
- Automatically add/remove rights to assignee
  - from the task definition
- operation SetACL
</section>

<section class="slide" id="tracability">
###Tracability

- Log with audit with automation audit
- Can be used for stats

</section>

<section class="slide" id="startwofkflow">
###Automatically start workflow
 - From a user action
 - From a event handler
 - From a REST call
 
Use the operation *Workflow Context > Start workflow*
</section>

<section class="slide" id="end">
Thank you
------------
  </section>

  <!-- deck.navigation snippet -->
  <a href="#" class="deck-prev-link" title="Previous">&#8592;</a>
  <a href="#" class="deck-next-link" title="Next">&#8594;</a>

  <!-- deck.status snippet -->
  <p class="deck-status">
    <span class="deck-status-current"></span> / <span
      class="deck-status-total"></span>
  </p>

  <!-- deck.goto snippet -->
  <form action="." method="get" class="goto-form">
    <label for="goto-slide">Go to slide:</label> <input type="text"
      name="slidenum" id="goto-slide" list="goto-datalist">
    <datalist id="goto-datalist"></datalist>
    <input type="submit" value="Go">
  </form>

  <!-- deck.hash snippet -->
  <a href="." title="Permalink to this slide" class="deck-permalink">#</a>

  <!-- Grab CDN jQuery, with a protocol relative URL; fall back to local if offline -->
  <script
    src="//ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
  <!-- script>window.jQuery || document.write('<script src="deck.js/jquery-1.7.2.min.js"><\/script>')</script -->
  <script>window.jQuery || document.write('<script src="deck.js/jquery-1.7.2.min.js"><\/script>')</script>


  <!-- Deck Core and extensions -->
  <script src="deck.js/core/deck.core.js"></script>
  <script src="deck.js/extensions/hash/deck.hash.js"></script>
  <script src="deck.js/extensions/menu/deck.menu.js"></script>
  <script src="deck.js/extensions/goto/deck.goto.js"></script>
  <script src="deck.js/extensions/status/deck.status.js"></script>
  <script src="deck.js/extensions/navigation/deck.navigation.js"></script>
  <script src="deck.js-markdown/deck.markdown.js/Markdown.Converter.js"></script>
  <script src="deck.js-markdown/deck.markdown.js/deck.markdown.js"></script>
  <script src="deck.js/extensions/scale/deck.scale.js"></script>
  <!-- Initialize the deck -->
  <script>
			$(function() {
				$.deck('.slide');
			});
		</script>

</body>
</html>
